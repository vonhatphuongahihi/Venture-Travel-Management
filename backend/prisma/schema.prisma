// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId             String        @id @default(uuid()) @map("user_id")
  name               String
  email              String        @unique
  password           String?
  phone              String?
  address            String?
  profilePhoto       String?       @map("profile_photo")
  dateOfBirth        DateTime?     @map("date_of_birth")
  gender             String?
  role               Role          @default(USER)
  isActive           Boolean       @default(true) @map("is_active")
  isVerified         Boolean       @default(false) @map("is_verified")
  verificationToken  String?       @map("verification_token")
  verificationExpires DateTime?    @map("verification_expires")
  resetToken         String?       @unique @map("reset_token")
  resetExpires       DateTime?     @map("reset_expires")
  lastLogin          DateTime?     @map("last_login")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Google OAuth fields
  googleId           String?       @unique @map("google_id")
  authProvider       AuthProvider  @default(LOCAL) @map("auth_provider")

  @@map("users")
}

model Province {
  provinceId  String      @id @map("province_id")
  name        String
  images      String[]
  region      String      // Báº¯c, Trung, Nam
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  attractions Attraction[]
  tours       Tour[]

  @@map("provinces")
}

model Attraction {
  attractionId  String    @id @map("attraction_id")
  name          String
  images        String[]
  address       String
  description   String
  geom          String   
  provinceId    String    @map("province_id")
  category      String    // Beach, Historical, Cultural, etc.
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  province      Province  @relation(fields: [provinceId], references: [provinceId])
  tourStops     TourStop[]
  point         Point     @relation(fields: [geom], references: [pointId])

  @@map("attractions")
}

model Tour {
  tourId                  String        @id @default(uuid()) @map("tour_id")
  provinceId              String        @map("province_id")
  name                    String
  images                  String[]
  about                   String
  ageRange                String        @map("age_range")
  maxGroupSize            Int           @map("max_group_size")
  duration                String
  languages               String[]
  categories              String[]
  highlights              String[]
  inclusions              String[]
  exclusions              String[]
  expectations            String
  pickupPoint             String        @map("pickup_point")
  pickupPointGeom         String       @map("pickup_point_geom") 
  pickupDetails           String       @map("pickup_details")
  pickupAreaGeom          String       @map("pickup_area") 
  endPoint                String?       @map("end_point")
  endPointGeom            String?       @map("end_point_geom") 
  additionalInformation   String?       @map("additional_information")
  cancellationPolicy      String        @map("cancellation_policy")
  startDate               DateTime?      @map("start_date")
  endDate                 DateTime?      @map("end_date")
  isActive                Boolean       @default(true) @map("is_active")
  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")

  // Relations
  province                Province      @relation(fields: [provinceId], references: [provinceId])
  pickup                  Point         @relation("TourPickupPoint", fields: [pickupPointGeom], references: [pointId], onDelete: Cascade)
  end                     Point?        @relation("TourEndPoint", fields: [endPointGeom], references: [pointId], onDelete: Cascade)
  pickupArea              Polygon       @relation(fields: [pickupAreaGeom], references: [polygonId], onDelete: Cascade)
  tourStops               TourStop[]
  ticketTypes             TicketType[]

  @@map("tours")
}

model TourStop {
  stopId          String      @id @default(uuid()) @map("stop_id")
  tourId          String      @map("tour_id")
  attractionId    String      @map("attraction_id")
  stopOrder       Int         @map("stop_order")
  notes           String?
  details         String?
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  tour            Tour        @relation(fields: [tourId], references: [tourId])
  attraction      Attraction  @relation(fields: [attractionId], references: [attractionId])

  @@map("tour_stops")
}

model TicketType {
  ticketTypeId    String        @id @default(uuid()) @map("ticket_type_id")
  tourId          String        @map("tour_id")
  name            String
  notes           String?
  quantity        Int
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  tour            Tour          @relation(fields: [tourId], references: [tourId])
  ticketPrices    TicketPrice[]

  @@map("ticket_types")
}

model PriceCategory {
  categoryId      String        @id @default(uuid()) @map("category_id")
  name            String
  description     String?
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  ticketPrices    TicketPrice[]

  @@map("price_categories")
}

model TicketPrice {
  ticketPriceId   String        @id @default(uuid()) @map("ticket_price_id")
  ticketTypeId    String        @map("ticket_type_id")
  categoryId      String        @map("category_id")
  notes           String?
  price           Float         // numeric
  quantity        Int
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  ticketType      TicketType    @relation(fields: [ticketTypeId], references: [ticketTypeId])
  priceCategory   PriceCategory @relation(fields: [categoryId], references: [categoryId])

  @@map("ticket_prices")
}

model Point {
  pointId       String    @id @default(uuid()) @map("point_id")
  latitude      Float
  longitude     Float

  // Relation
  attractions     Attraction[]
  pickupTours     Tour[]        @relation("TourPickupPoint")
  endPointTours   Tour[]      @relation("TourEndPoint")
  nodes           Node[]
  arcPoints       ArcPoint[]
  polygonPoints    PolygonPoint[]

  @@map("points")
}

model Node {
  nodeId     String   @id @default(uuid()) @map("node_id")
  pointId    String   @unique @map("point_id")
  point      Point    @relation(fields: [pointId], references: [pointId])

  // Relation
  startArcs Arc[] @relation("ArcStart")
  endArcs   Arc[] @relation("ArcEnd")

  @@map("nodes")
}

model Arc {
  arcId       String  @id @default(uuid()) @map("arc_id")
  startNodeId String  @map("start_node_id")
  endNodeId   String  @map("end_node_id")

  startNode   Node   @relation("ArcStart", fields: [startNodeId], references: [nodeId])
  endNode     Node   @relation("ArcEnd", fields: [endNodeId], references: [nodeId])

  arcPoints   ArcPoint[]

  @@map("arcs")
}

model ArcPoint {
  arcId   String @map("arc_id")
  pointId String @map("point_id")

  arc     Arc   @relation(fields: [arcId], references: [arcId])
  point   Point @relation(fields: [pointId], references: [pointId])

  @@id([arcId, pointId])

  @@map("arc_points")
}

model Polygon {
  polygonId       String  @id @default(uuid()) @map("polygon_id")

  polygonPoints    PolygonPoint[]
  tourPickUpAreas   Tour[]

  @@map("polygons")
}

model PolygonPoint {
  polygonId  String @map("polygonId")
  pointId String @map("pointId")

  polygon    Polygon   @relation(fields: [polygonId], references: [polygonId])
  point   Point  @relation(fields: [pointId], references: [pointId])

  @@id([polygonId, pointId])

  @@map("polygon_points")
}

enum Role {
  ADMIN
  USER
  GUEST
}

enum AuthProvider {
  LOCAL
  GOOGLE
}
